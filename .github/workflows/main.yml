name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Install build tools
      run: |
        brew install autoconf automake libtool pkg-config
        brew install openssl readline sqlite3 xz zlib
    
    - name: ğŸ“¦ Cache kivy-ios
      uses: actions/cache@v3
      with:
        path: ~/kivy-ios
        key: kivy-ios-build
    
    - name: ğŸ—ï¸ Build kivy-ios
      run: |
        cd ~
        if [ ! -d "kivy-ios" ]; then
          git clone https://github.com/kivy/kivy-ios
          cd kivy-ios
          ./toolchain.py build python3 kivy
        fi
    
    - name: ğŸ“š Install dependencies
      run: |
        mkdir -p site-packages
        pip3 install --target=site-packages arabic-reshaper python-bidi
    
    - name: ğŸ¯ Create Xcode project
      run: |
        cd ~/kivy-ios
        ./toolchain.py create ShippingApp ${{ github.workspace }}/shipping_apps
    
    - name: ğŸ”¨ Build app
      run: |
        cd ~/kivy-ios/ShippingApp-ios
        xcodebuild -project ShippingApp.xcodeproj \
          -scheme ShippingApp \
          -sdk iphonesimulator \
          -configuration Release \
          CODE_SIGNING_ALLOWED=NO
    
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4    â† v4 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† v3
      with:
        name: ShippingApp-iOS
        path: ~/kivy-ios/ShippingApp-ios/build/
