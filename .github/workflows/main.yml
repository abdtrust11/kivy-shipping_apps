name: Build iOS App

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  APP_NAME: ShippingApp

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ Prepare Homebrew (Apple Silicon)
        shell: bash
        run: |
          if [ -x /opt/homebrew/bin/brew ]; then
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.bash_profile
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          brew --version

      - name: ğŸ“¦ Install build tools
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          brew update
          # Ø­Ø²Ù… Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù€ kivy-ios
          brew install autoconf automake libtool pkg-config ccache xz sqlite readline openssl@3 zlib || true

      - name: ğŸ“¦ Cache kivy-ios
        uses: actions/cache@v3
        with:
          path: ~/kivy-ios
          key: kivy-ios-${{ runner.os }}-macos14-v1

      - name: ğŸ—ï¸ Fetch & build kivy-ios recipes
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~
          if [ ! -d "kivy-ios" ]; then
            git clone https://github.com/kivy/kivy-ios
          fi
          cd kivy-ios
          # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨Ø§ÙŠØ«ÙˆÙ† ÙˆØ±ÙƒØ§Ø¦Ø¨ SDL Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          ./toolchain.py build python3 sdl2 sdl2_image sdl2_mixer sdl2_ttf pillow pyobjus kivy

          # ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø¯Ø§Ø®Ù„ Ø¨ÙŠØ¦Ø© Python-iOS (ÙˆÙ„ÙŠØ³ pip Ù„Ù„Ù†Ø¸Ø§Ù…)
          ./toolchain.py pip install "cython<3.0" arabic-reshaper python-bidi

      - name: ğŸ¯ Create Xcode project
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~/kivy-ios
          # Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù„Ø¯ ÙƒÙˆØ¯Ùƒ ÙƒÙ…ØµØ¯Ø± Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
          ./toolchain.py create "$APP_NAME" "${{ github.workspace }}"
          ls -la "$APP_NAME-ios"

      - name: ğŸ”¨ Build app (Simulator, unsigned)
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~/kivy-ios/"$APP_NAME"-ios
          # Ù†Ø¨Ù†ÙŠ Ù„Ù„Ù…Ø­Ø§ÙƒÙŠ Ù…Ø¹ ÙˆØ¬Ù‡Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø³Ø§Ø± Ù…Ø®Ø±Ø¬Ø§Øª Ù…Ø­Ø¯Ø¯
          xcodebuild \
            -project "$APP_NAME.xcodeproj" \
            -scheme "$APP_NAME" \
            -configuration Release \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build

          echo "Build products:"
          find build -maxdepth 3 -type d -name "*.app" -print || true

      - name: ğŸ“¤ Upload artifact (.app)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-iOS-simulator
          path: |
            ~/kivy-ios/${{ env.APP_NAME }}-ios/build/Build/Products/Release-iphonesimulator/*.app
