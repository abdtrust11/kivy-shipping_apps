name: Build iOS App

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  APP_NAME: ShippingApp
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  build-ios:
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Ù„Ø§ ØªØºÙŠÙ‘Ø± PATH Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Homebrew Ø­ØªÙ‰ Ù„Ø§ ÙŠØ·ØºÙ‰ Ø¹Ù„Ù‰ pythonLocation
      - name: ğŸ”§ Homebrew info (no shellenv)
        shell: bash
        run: |
          /opt/homebrew/bin/brew --version || brew --version
          echo "pythonLocation=${pythonLocation}"
          which python3
          python3 --version

      - name: ğŸ“¦ Install build tools
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          brew update
          brew install autoconf automake libtool pkg-config ccache xz sqlite readline openssl@3 zlib || true

      # âœ… Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…ÙØ³Ø± setup-python Ø¯Ø§Ø¦Ù…Ø§Ù‹
      - name: ğŸ§° Install Python deps for kivy-ios toolchain (host)
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          "${pythonLocation}/bin/python" -m pip install --upgrade pip
          "${pythonLocation}/bin/python" -m pip install "cython<3.0" sh packaging pbxproj

      - name: ğŸ“¦ Cache kivy-ios
        uses: actions/cache@v3
        with:
          path: ~/kivy-ios
          key: kivy-ios-${{ runner.os }}-macos14-v1

      - name: ğŸ—ï¸ Fetch & build kivy-ios recipes
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~
          if [ ! -d "kivy-ios" ]; then
            git clone https://github.com/kivy/kivy-ios
          fi
          cd kivy-ios
          # Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          "${pythonLocation}/bin/python" ./toolchain.py build python3 sdl2 sdl2_image sdl2_mixer sdl2_ttf pillow pyobjus kivy
          # Ù…ÙƒØªØ¨Ø§Øª Ø¨Ø§ÙŠØ«ÙˆÙ† Ø¯Ø§Ø®Ù„ Ø¨ÙŠØ¦Ø© Python-iOS (ØªÙØ¶Ù…Ù‘Ù† ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚)
          "${pythonLocation}/bin/python" ./toolchain.py pip install "cython<3.0" arabic-reshaper python-bidi

      - name: ğŸ¯ Create Xcode project
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~/kivy-ios
          "${pythonLocation}/bin/python" ./toolchain.py create "$APP_NAME" "${{ github.workspace }}"
          ls -la "$APP_NAME-ios"

      - name: ğŸ”¨ Build app (Simulator, unsigned)
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          cd ~/kivy-ios/"$APP_NAME"-ios
          xcodebuild \
            -project "$APP_NAME.xcodeproj" \
            -scheme "$APP_NAME" \
            -configuration Release \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath build

          echo "Build products:"
          find build -maxdepth 3 -type d -name "*.app" -print || true

      - name: ğŸ“¤ Upload artifact (.app)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-iOS-simulator
          path: |
            ~/kivy-ios/${{ env.APP_NAME }}-ios/build/Build/Products/Release-iphonesimulator/*.app
